#!/bin/bash
set -evu

# Usage:
#
# build-test [mypy|nomypy]
#
# Arguments:
# - mypy: include mypy check ("mypy" or "nomypy")
#
# Environment variables used:
# - GITHUB_WORKSPACE: workspace directory
#
# WARNING: running this locally will delete any local files that
# aren't strictly part of the git tree, including gitignored files!

MODULE=pytket-custatevec

MYPY=$1

PLAT=`python -c 'import platform; print(platform.system())'`

PYVER=`python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))'`

git clean -dfx

echo "Module to test: ${MODULE}"

MODULEDIR="${GITHUB_WORKSPACE}"
ARTIFACTSDIR=${GITHUB_WORKSPACE}/wheelhouse

rm -rf ${ARTIFACTSDIR} && mkdir ${ARTIFACTSDIR}

python -m pip install --upgrade pip wheel build

# 1. Build the package (sdist and wheel)
python -m build

# 2. Copy the new wheel to your artifacts directory
cp dist/*.whl ${ARTIFACTSDIR}

# Test and mypy:
if [[ "${MYPY}" = "mypy" ]]
then
    # Note: If mypy is in your [dev] dependencies, this line isn't needed.
    python -m pip install "mypy==1.11.2"
fi

# 3. Install the package in editable mode WITH all test dependencies
# This is now the ONLY installation step needed for testing.
python -m pip install -e .[dev,test]

# --- âœ… ADD THIS ENTIRE DEBUGGING BLOCK ---
echo "--- ðŸ•µï¸ DEBUGGING PYTHON ENVIRONMENT ---"
echo "-> Python executable:"
which python
python --version
echo "-> Pip packages installed:"
pip list
echo "-> Python sys.path:"
python -c "import sys; from pprint import pprint; pprint(sys.path)"
echo "-> Attempting to import cuquantum directly:"
python -c "import cuquantum; print(f'Successfully imported cuquantum from: {cuquantum.__file__}')"
echo "--- END DEBUGGING ---"

# 4. Run the tests
cd ${GITHUB_WORKSPACE}/tests
pytest
cd ..

if [[ "${MYPY}" = "mypy" ]]
then
    ${GITHUB_WORKSPACE}/mypy-check ${GITHUB_WORKSPACE}
fi