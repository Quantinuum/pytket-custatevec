name: Test (uv, Py3.12)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Ensure python3.12 exists
        shell: bash
        run: |
          command -v python3.12 >/dev/null || { echo "python3.12 not found"; exit 1; }
          python3.12 -V

      - name: Install uv (no sudo)
        shell: bash
        run: |
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv --version

      - name: Create venv, install, and test
        shell: bash
        run: |
          set -euo pipefail
          # venv reuses system packages if present
          uv venv --python python3.12 --system-site-packages .venv
          source .venv/bin/activate

          # Install your project WITH dependencies + test extras
          # (installs cupy-cuda12x and cuquantum-python-cu12 if missing)
          uv pip install ".[test]"

          # Run tests
          pytest -q
