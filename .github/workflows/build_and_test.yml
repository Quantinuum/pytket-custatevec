name: Test (uv, 3.12 & 3.11)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        include:
          - py: "python3.12"
            ver: "3.12"
          - py: "python3.11"
            ver: "3.11"

    steps:
      - uses: actions/checkout@v4

      - name: Install uv (no sudo)
        shell: bash
        run: |
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          uv --version

      - name: Ensure ${{ matrix.py }} exists (install locally if missing)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v ${{ matrix.py }} >/dev/null 2>&1; then
            echo "${{ matrix.py }} not found; installing locally with uv..."
            uv python install "${{ matrix.ver }}"
          fi
          ${{ matrix.py }} -V

      - name: Create venv, install deps, run tests
        shell: bash
        run: |
          set -euo pipefail
          PYBIN="$(uv python find '${{ matrix.ver }}')"
          echo "Using interpreter: $PYBIN"

          # Reuse preinstalled libs if present; otherwise uv will fetch them
          uv venv --python "$PYBIN" --system-site-packages .venv
          source .venv/bin/activate

          # Install your package with deps + test extras
          uv pip install ".[test]"

          # Run the full test suite
          pytest -q
